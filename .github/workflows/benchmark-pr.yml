name: Benchmark PR

on:
  pull_request:
    branches: [main]
    paths:
      - 'src/day*.rs'

env:
  CARGO_TERM_COLOR: always

jobs:
  detect:
    runs-on: ubuntu-latest
    outputs:
      day: ${{ steps.detect.outputs.day }}
    permissions:
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Detect changed day
        id: detect
        run: |
          CHANGED_DAYS=$(git diff --name-only origin/main...HEAD -- 'src/day*.rs' | grep -oP 'day\K\d+' | sort -u)
          COUNT=$(echo "$CHANGED_DAYS" | grep -c . || echo 0)

          if [ "$COUNT" -eq 0 ]; then
            echo "No day files changed"
            exit 0
          elif [ "$COUNT" -gt 1 ]; then
            echo "error=PR changes multiple days. Please submit one day per PR." >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "day=$(echo $CHANGED_DAYS | head -1)" >> $GITHUB_OUTPUT

      - name: Reject multi-day PR
        if: steps.detect.outputs.error != ''
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: '## PR Rejected\n\n${{ steps.detect.outputs.error }}'
            });
            core.setFailed('${{ steps.detect.outputs.error }}');

  verify:
    needs: detect
    if: needs.detect.outputs.day != ''
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Rust
        uses: dtolnay/rust-action@stable

      - name: Install cargo-aoc
        run: cargo install cargo-aoc

      - name: Set AOC credentials
        run: cargo aoc credentials -s ${{ secrets.AOC_TOKEN }}

      - name: Download input
        run: cargo aoc input -d ${{ needs.detect.outputs.day }} -y 2025

      - name: Run PR solution
        run: |
          cargo aoc -d ${{ needs.detect.outputs.day }} 2>&1 | tee /tmp/pr_result.txt
          cp -r input /tmp/saved_input

      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main
          clean: false

      - name: Run main solution
        run: |
          mkdir -p input && cp -r /tmp/saved_input/* input/
          cargo aoc -d ${{ needs.detect.outputs.day }} 2>&1 | tee /tmp/main_result.txt || echo "NOT_IMPLEMENTED" > /tmp/main_result.txt

      - name: Extract branch results
        id: extract
        run: |
          PR_RESULT=$(grep -E "Part [12] :" /tmp/pr_result.txt || cat /tmp/pr_result.txt)
          {
            echo "pr_result<<EOF"
            echo "$PR_RESULT"
            echo "EOF"
          } >> $GITHUB_OUTPUT
          echo "Branch results: $PR_RESULT"

      - name: Compare with main
        id: verify
        run: |
          DAY=${{ needs.detect.outputs.day }}

          if grep -q "NOT_IMPLEMENTED" /tmp/main_result.txt; then
            echo "New day implementation - skipping verification"
            echo "new_day=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          PR_RESULT="${{ steps.extract.outputs.pr_result }}"
          MAIN_RESULT=$(grep -E "Part [12] :" /tmp/main_result.txt || cat /tmp/main_result.txt)

          if [ "$PR_RESULT" != "$MAIN_RESULT" ]; then
            echo "Results mismatch!"
            echo "PR: $PR_RESULT"
            echo "Main: $MAIN_RESULT"
            exit 1
          fi

          echo "Results match"

      - name: Comment on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: '## Day ${{ needs.detect.outputs.day }} - Verification FAILED\n\nPR produces different results than main branch.'
            });

  benchmark:
    needs: [detect, verify]
    if: needs.detect.outputs.day != ''
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Rust
        uses: dtolnay/rust-action@stable

      - name: Install cargo-aoc
        run: cargo install cargo-aoc

      - name: Set AOC credentials
        run: cargo aoc credentials -s ${{ secrets.AOC_TOKEN }}

      - name: Download input
        run: cargo aoc input -d ${{ needs.detect.outputs.day }} -y 2025

      - name: Benchmark PR
        run: |
          cargo aoc bench -d ${{ needs.detect.outputs.day }} 2>&1 | tee /tmp/pr_bench.txt
          cp -r input /tmp/saved_input

      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main
          clean: false

      - name: Benchmark main
        run: |
          mkdir -p input && cp -r /tmp/saved_input/* input/
          cargo aoc bench -d ${{ needs.detect.outputs.day }} 2>&1 | tee /tmp/main_bench.txt || echo "NOT_IMPLEMENTED" > /tmp/main_bench.txt

      - name: Compare benchmarks
        id: compare
        run: |
          DAY=${{ needs.detect.outputs.day }}

          if grep -q "NOT_IMPLEMENTED" /tmp/main_bench.txt; then
            echo "pass=true" >> $GITHUB_OUTPUT
            {
              echo "report<<EOF"
              echo -e "## Day $DAY - New Implementation\n\nNo benchmark comparison needed."
              echo "EOF"
            } >> $GITHUB_OUTPUT
            exit 0
          fi

          PR_TIME=$(grep -oP 'time:\s+\[\K[0-9.]+ [µa-z]+' /tmp/pr_bench.txt | head -1)
          MAIN_TIME=$(grep -oP 'time:\s+\[\K[0-9.]+ [µa-z]+' /tmp/main_bench.txt | head -1)

          to_ns() {
            local num=$(echo "$1" | grep -oP '^[0-9.]+')
            local unit=$(echo "$1" | grep -oP '[µa-z]+$')
            case $unit in
              ns) echo "$num" ;;
              µs|us) echo "$(echo "$num * 1000" | bc)" ;;
              ms) echo "$(echo "$num * 1000000" | bc)" ;;
              s) echo "$(echo "$num * 1000000000" | bc)" ;;
              *) echo "$num" ;;
            esac
          }

          PR_NS=$(to_ns "$PR_TIME")
          MAIN_NS=$(to_ns "$MAIN_TIME")

          REPORT="## Day $DAY - Benchmark\n\n| Branch | Time |\n|--------|------|\n| PR | $PR_TIME |\n| Main | $MAIN_TIME |\n\n"

          if [ "$(echo "$PR_NS <= $MAIN_NS" | bc -l)" = "1" ]; then
            SPEEDUP=$(echo "scale=1; ($MAIN_NS - $PR_NS) / $MAIN_NS * 100" | bc)
            REPORT+="**PASSED** - ${SPEEDUP}% faster"
            echo "pass=true" >> $GITHUB_OUTPUT
          else
            SLOWDOWN=$(echo "scale=1; ($PR_NS - $MAIN_NS) / $MAIN_NS * 100" | bc)
            REPORT+="**FAILED** - ${SLOWDOWN}% slower"
            echo "pass=false" >> $GITHUB_OUTPUT
          fi

          {
            echo "report<<EOF"
            echo -e "$REPORT"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Post PR comment
        uses: actions/github-script@v7
        with:
          script: |
            const body = `${{ steps.compare.outputs.report }}\n\n---\n*Automated benchmark*`;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const existing = comments.find(c => c.user.type === 'Bot' && c.body.includes('Day '));

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body
              });
            }

      - name: Check result
        run: |
          [ "${{ steps.compare.outputs.pass }}" = "true" ] || exit 1

      - name: Auto-approve PR
        if: steps.compare.outputs.pass == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              event: 'APPROVE',
              body: 'Automated approval: Solution is correct and faster/equal to current implementation.'
            });
